trigger:
  branches:
    include:
    - '*'

stages:
- stage: test
  jobs:

  - job: macos
    pool:
      vmImage: 'macOS-12'
    strategy:
      matrix:
        Python37:
          python.version: '3.7'
        Python38:
          python.version: '3.8'
        Python39:
          python.version: '3.9'
        Python310:
          python.version: '3.10'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(python.version)'
        architecture: 'x64'
    - template: .azure-pipelines/build-run-tests.yml

- stage: build_wheels
  jobs:
  - job: macos_universal2
    pool:
      vmImage: 'macOS-12'
    steps:
      - task: UsePythonVersion@0
      - bash: |
          set -o errexit
          python3 -m pip install --upgrade pip
          python3 -m pip install cibuildwheel==2.8.0
        displayName: Install cibuildwheel dependencies
      - bash: cibuildwheel --output-dir wheelhouse .
        env:
          CIBW_BUILD_VERBOSITY: 3
          CIBW_SKIP: "cp36-* cp37-* cp38-*"
          ABI_VERSION: 'cp36'
          DEPLOYMENT_TARGET: '10.10'
          CIBW_ARCHS_MACOS: universal2
          CIBW_ENVIRONMENT: "CLAGS='-mmacosx-version-min=10.10'"
          ARCHFLAGS: '-arch x86_64 -arch arm64'
          _PYTHON_HOST_PLATFORM: 'macosx-10.9-universal2'
          CMAKE_OSX_ARCHITECTURES: 'x86_64;arm64'
        displayName: Build wheels
      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: wheelhouse
          artifactName: wheels
